name: Dynamic Deployment

on:
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Display Configuration
        run: |
          echo "=== Deployment Configuration ==="
          echo "Region: ${{ github.event.client_payload.region }}"
          echo "Environment: ${{ github.event.client_payload.environment }}"
          echo "Cluster: ${{ github.event.client_payload.cluster }}"
          echo "Namespace: ${{ github.event.client_payload.namespace }}"
          echo "Version: ${{ github.event.client_payload.version }}"
          echo "Triggered by: ${{ github.event.client_payload.triggered_by }}"
          echo "Timestamp: ${{ github.event.client_payload.timestamp }}"
      
      - name: Validate Configuration
        run: |
          # Load the config file
          CONFIG_FILE=".github/config/deployment-options.json"
          
          REGION="${{ github.event.client_payload.region }}"
          ENV="${{ github.event.client_payload.environment }}"
          CLUSTER="${{ github.event.client_payload.cluster }}"
          NAMESPACE="${{ github.event.client_payload.namespace }}"
          
          # Validate cluster exists for this region/environment
          VALID_CLUSTER=$(jq -r --arg r "$REGION" --arg e "$ENV" --arg c "$CLUSTER" \
            '.regions[$r].environments[$e].clusters | index($c) != null' $CONFIG_FILE)
          
          if [ "$VALID_CLUSTER" != "true" ]; then
            echo "‚ùå Invalid cluster for $REGION/$ENV"
            exit 1
          fi
          
          # Validate namespace
          VALID_NAMESPACE=$(jq -r --arg r "$REGION" --arg e "$ENV" --arg n "$NAMESPACE" \
            '.regions[$r].environments[$e].namespaces | index($n) != null' $CONFIG_FILE)
          
          if [ "$VALID_NAMESPACE" != "true" ]; then
            echo "‚ùå Invalid namespace for $REGION/$ENV"
            exit 1
          fi
          
          echo "‚úÖ Configuration validated successfully"
      
      - name: Deploy to AKS
        run: |
          echo "üöÄ Deploying to AKS..."
          echo "Cluster: ${{ github.event.client_payload.cluster }}"
          echo "Namespace: ${{ github.event.client_payload.namespace }}"
          echo "Version: ${{ github.event.client_payload.version }}"
          
          # Your actual deployment commands here
          # az aks get-credentials --name ${{ github.event.client_payload.cluster }} --resource-group rg-${{ github.event.client_payload.environment }}
          # kubectl apply -f deployment.yaml --namespace=${{ github.event.client_payload.namespace }}
